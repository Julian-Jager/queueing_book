\section{Little's Law}
\label{sec:littles-law}


\opt{solutionfiles}{
\subsection*{Theory and Exercises}
\Opensolutionfile{hint}
\Opensolutionfile{ans}
}

There is an important relation between the average time $\E W$ a job
spends in the system and the long-run time-average number $\E L$ of jobs
that is contained in the system, which is called \emph{Little's law}:
\begin{equation}\label{eq:53}
 \E L = \lambda \E W.
\end{equation}
\Cref{ex:62} provides a proof of this under some simple conditions.
In the forthcoming sections, we will apply Little's law often.
Part of the usefulness of Little's law is that it applies to all input-output systems, whether it is a queueing system or an inventory system or some much more general system.

We start by defining a few intuitively useful concepts. From~\cref{eq:14}, we see that
\begin{equation*}
\frac 1 t\int_0^t L(s)\, \d s = \frac 1 t\int_0^t (A(s)-D(s)) \, \d s
\end{equation*}
is the time-average of the number of jobs in the system during
$[0,t]$.
% Observe once again from the second equation that
% $\int_0^t L(s)\,\d s$ is the area enclosed between the graphs of $A(s)$
% and $D(s)$.
Next, the waiting time of the $k$th job is the time between the moment the
job arrives and departs, that is, 
\begin{equation*}
 W_k = \int_0^\infty \1{A_k \leq s < D_k}\,\d s.
\end{equation*}
\cref{fig:atltdt}  relates $W_k$ to $L(t)$.

Consider a departure time $T$ at which the system is empty so that $A(T) = D(T)$.
%as at time $T$ all jobs that arrived up to $T$ also have left.
%As for all jobs $k\leq A(T)$ we have that $D_k \leq T$, we can replace the integration bounds in the above expression for $W_k$ by
Then, for $k\leq A(T)$, 
\begin{equation*}
 W_k = \int_0^T \1{A_k \leq s < D_k}\,\d s,
\end{equation*}
and for $s\leq T$,
\begin{equation*}
L(s) = \sum_{k=1}^\infty \1{A_k \leq s < D_k} = \sum_{k=1}^{A(T)}\1{A_k \leq s < D_k}.
\end{equation*}

\begin{exercise}\clabel{ex:62}
 Prove Little's law under the assumptions that $A(T_i) = D(T_i)$ for an infinite number of times $\{T_i\}$ such $T_i\to\infty$ and that all limits exist. 
\begin{solution}
 See~\cref{ex:59}--\cref{ex:61}. 
\end{solution}
\end{exercise}


\begin{extra}\clabel{ex:59}
 Show that 
\begin{equation*}
 \int_0^T L(s)\, \d s = \sum_{k=1}^{A(T)} W_k.
\end{equation*}
\begin{hint}
 Substitute the definition of $L(s)$ in the left-hand side, then reverse the integral and summation.
\end{hint}
\begin{solution}
\begin{equation*}
 \begin{split}
 \int_0^T L(s)\, \d s & = \int_0^T \sum_{k=1}^{A(T)} 1\{A_k \leq s < D_k\} \, \d s \\
& = \sum_{k=1}^{A(T)}\int_0^T 1\{A_k \leq s < D_k\} \, \d s = \sum_{k=1}^{A(T)} W_k.
 \end{split}
\end{equation*}
\end{solution}
\end{extra}


\begin{extra}\clabel{ex:60}
 Use the result of the previous exercise to show~\cref{eq:53}. 
\begin{hint}
 Divide both sides by $T$. At the right-hand side use that $1/T = A(T)/T \cdot 1/A(T)$. Take limits.
\end{hint}
\begin{solution}
From the previous exercise:
\begin{equation*}
 \frac 1 T \int_0^T L(s)\, \d s = \frac{A(T)} T \frac{1}{A(T)} \sum_{k=1}^{A(T)} W_k.
\end{equation*}
Assuming there are an infinite number of times
$0\leq T_i<T_{i+1}<\cdots$, $T_i\to\infty$, at which $A(T_i) = D(T_i)$
and the following limits exist
\begin{align*}
\frac 1 T \int_0^T L(s)\, \d s &\to \E L,&
\frac{A(T_i)}{T_i} &\to \lambda, &
\frac{1}{A(T_i)} \sum_{k=1}^{A(T_i)} W_k &\to \E W,
\end{align*}
we obtain Little's law.
\end{solution}
\end{extra}



\begin{extra}\clabel{ex:61}
 Which assumptions have we used to prove Little's law?
\begin{solution}
 We assumed first that $A(t)/t \to \lambda$ as $t\to \infty$, i.e., $A(t)/t$ has a limit as $t$ converges to $\infty$.
 Second, there exists a sequence of points $T_k, k=0,1,2,\ldots$ in time such that the server is idle.
 Third, either of the limits $\sum_k^n W_k/n = \sum_k^n S_k /n $ or $t^{-1}\int_0^t L(s) \d s$ exists, in which case the other exists.
\end{solution}
\end{extra}

\begin{extra}
Observe that the area between the graphs of $A(s)$ and $D(s)$ must
be equal to the total waiting time spent by all jobs in the system
until $T$. Use this to provide a graphical interpretation of the proof of Little's law.
\begin{hint}
 Make a drawing of $A(t)$ and $D(t)$ until time $T$, i.e., the
 first time the system is empty. Observe that $A(t)-D(t)$ is the number of jobs in the system. Take some level $k$, and compute $A_k = A^{-1}(k)$ and $D_k = D^{-1}(k)$. Observe that $D_k - A_k = D^{-1}(k) - A^{-1}(k)$ is the waiting time of job $k$.
\end{hint}
\begin{solution}
 The area enclosed between the graphs of $A(t)$ and $D(t)$ until
 $T$ can be `chopped up' in two ways: in the horizontal
 and in the vertical direction. (Please make the drawing as you go
 along\ldots) A horizontal line between $A(t)$ and $D(t)$
 corresponds to the waiting time of a job, while a vertical line
 corresponds to the number of jobs in the system at time $t$. Now
 adding all horizontal lines (by integrating along the $y$-axis)
 makes up the total amount of waiting done by all the jobs until
 time $T$. On the other hand, adding the vertical lines (by
 integrating along the $x$-axis) is equal to the summation of all
 jobs in the system. Since the area is the same no matter whether
 you sum it in the horizontal or vertical direction:
 \begin{equation*}
 \sum_{k=1}^{A(T)} W_k = \text{enclosed area} = \int_0^T (A(t)-D(t))\,dt. 
 \end{equation*}
 Dividing both sides by $A(T)$ gives
 \begin{equation*}
\frac{1}{A(T)} \sum_{k=1}^{A(T)} W_k =\frac{1}{A(T)} \int_0^T (A(t)-D(t))\,dt. 
 \end{equation*}

 Finally, observe that this equality holds between any two times
 $T_i, T_{i+1}$, where times $\{T_i\}$ are such that
 $A(T_i)=D(T_i)$. Then, as $T_i\to \infty$, which we assumed from
 the on-set, $\frac{1}{A(T_i)} \sum_{k=1}^{A(T_i)} W_k\to \E W$,
 and
 \begin{equation*}
\frac{T_i}{A(T_i)}\frac{1}{T_i} \int_0^{T_i} (A(t)-D(t))\,dt \to \lambda^{-1} \E L.
 \end{equation*}
Hence, Little's law follows.
\end{solution}
\end{extra}


\begin{extra}\clabel{ex:42}
 Use the dimensions of the components of Little's law to check that $\E{W} \neq \lambda \E{L}$.
\begin{hint}
Checking the dimensions in the formula prevents painful mistakes.
\end{hint}
\begin{solution}
 Sometimes (often?) students memorize Little's law in the wrong
 way. Thus, as an easy check, use the dimensions of the concepts:
 $\E L$ is an average \emph{number}, $\lambda$ is a \emph{rate},
 i.e., \emph{numbers per unit time}, and $\E W$ is waiting
 \emph{time}. 
\end{solution}
\end{extra}



\begin{extra}\clabel{ex:37}
 Consider the server of the $G/G/1$ queue as a system by itself.
 The time jobs stay in this system is $\E S$, and jobs arrive at rate $\lambda$.
 It follows from Little's law that $\rho = \lambda \E S$.
\begin{solution}
 The arrival rate at the server must be $\lambda$ and the time a job remains at the server is $\E S$.
 The fraction of time the server is busy is precisely the fraction of time there is a job present at the server.
 Thus, applying Little's law to the server itself, we see that $\rho = \E{L_S} = \lambda \E S$.
\end{solution}
\end{extra}


\begin{extra}\clabel{ex:43}
 For a given single-server queueing system the average number of customers in the system is $\E L = 10$, customers arrive at rate $\lambda=5$ per hour and are served at rate $\mu=6$ per hour.
 What is the average time customers spend in the system?
\begin{hint}
Start with checking the units when applying Little's law.
\end{hint}
\begin{solution}
 \begin{equation*}
 \E W = \E L/\lambda = 10/\lambda = 10/5 = 2.
 \end{equation*}
\end{solution}
\end{extra}

\begin{exercise}\clabel{ex:44}
 For a given single-server queueing system the average number of customers in the system is $\E L = 10$, customers arrive at rate $\lambda=5$ per hour and are served at rate $\mu=6$ per hour.
 Suppose that at the moment you join the system, the number of customers in the system is 10.
 What is your expected time in the system?
\begin{solution}
If you arrive at a queueing system, you first have to wait until the job in service is finished. Then you need to wait until the 9 jobs in queue are finished. This takes, in expectation, $9/\mu$. (Recall, 1 job is in service at the moment you arrive, so 9 are in queue.) Assuming that service times are exponential, so that, by the memoryless property, the remaining service time of the job in service is still $\E S$ when you arrive, you spend $10/\mu + 1/\mu = 11/6 \neq 2$. (To account for the last $+1/\mu$, observe that yourself also have to be served to compute the time you spend in the system.)


Now in this question, it is \emph{given} that the system
 length is 10 at the moment of arrival. However, $L$ as `seen' upon arrival by this
 given customer is in general not the same as the time-average $\E{L}$.

Thus, Little's law need not hold at all moments in time; it is a statement about \emph{averages}.
\end{solution}

\end{exercise}

With the PASTA property and Little's law it becomes quite easy to derive simple expressions for the average queue length and waiting times for the $M/M/1$ queue.
The average waiting time $\E W$ in the entire system is the expected time in queue plus the expected time in service, i.e.,
\begin{equation}\label{eq:78}
 \E W = \E{W_Q}+ \E S.
\end{equation}
By the PASTA property we have for the $M/M/1$ queue that
\begin{equation}\label{eq:wqes}
 \E{W_Q} = \E L \E S.
\end{equation}


\begin{exercise}\clabel{ex:l-215}
Use Little's law to show for the $M/M/1$ queue that 
 \begin{align*}
 \E W &= \frac{\E S}{1-\rho}, & \E L &= \frac\rho{1-\rho}, \\
 \E{L_Q} &= \frac{\rho^2}{1-\rho}, & \E{L_s} &= \rho.
 \end{align*}
\begin{hint}
 Combine~\cref{eq:78,eq:wqes} and apply Little's law. 
\end{hint}
\begin{solution}
\begin{align*}
 \E W &= \E L \E S + \E S = \lambda \E W \E S + \E S= \rho \E W + \E S. 
 \E L &= \lambda \E W = \frac{\lambda \E S}{1-\rho} = \frac\rho{1-\rho}, \\
 \E{W_q} &= \E W - \E S = \frac{\E S}{1-\rho} - \E S = \frac{\rho}{1-\rho} \E S,\\
 \E{L_Q} &= \lambda \E{W_Q} = \frac{\rho^2}{1-\rho}, \\
 \E{L_s} &= \E L - \E{L_Q} = \frac{\rho}{1-\rho} - \frac{\rho^2}{1-\rho} = \rho, 
\end{align*}
\end{solution}
\end{exercise}

\begin{exercise}\clabel{ex:l-216}
Why is~\cref{eq:wqes} \emph{not} true in general for the $M/G/1$ queue? 
\begin{solution}
 By the memoryless property of the (exponential) distributed service times of the $M/M/1$ queue, the duration of a job in service, if any, is $\Exp(\mu)$ also at an arrival moment.
 Therefore, at an arrival moment, all jobs in the system (whether in service or not) have the same expected duration.
 Hence, the expected time to spend in queue is the expected number of jobs in the system times the expected service time of each job, i.e., $\E{W_q} = \E L \E S$.
 Note that we use PASTA to see that the expected number of jobs in the system at an arrival is $\E{L}$.
 For the $M/G/1$ queue, the job in service (if any) does not have the same distribution as a job in queue.
 Hence, the expected time in queue is not $\E L \E S$.
\end{solution}
\end{exercise}


The following problems show how combining PASTA with Little's law allows the analysis of some non-trivial practical queueing situations.

% The problems below illustrate how to use Little's law and PASTA to analyze numerous queueing situations\footnote{When a problem is mainly of a computational type, I coded the solutions and show you all the steps in between so that you can check each step in your computations.
% As the code is typically nearly identical to the mathematical formulas, you should not have any difficulty understanding the code.
% (In the computations below I typically use the simplest, but often not the most efficient, code.)}.

\begin{extra}[Hall 5.2] \label{exer: Hall} 
After observing a single-server queue for several days, the following steady-state probabilities have been determined: $p(0)=0.4$, $p(1) = 0.3$, $p(2)=0.2$, $p(3)=0.05$ and $p(4)=0.05$.
 The arrival rate is 10 customers per hour.
 \begin{enumerate}
 \item Determine $\E L$ and $\E{L_Q}$. 
 \item Using Little's formula, determine $\E W$ and $\E{W_Q}$.
\item Determine $\V{L}$ and $\V{L_Q}$.
\item Determine the service time and the utilization.
 \end{enumerate}
\begin{solution} First find $\E L$


\begin{pyconsole}
P = [0.4, 0.3, 0.2, 0.05, 0.05]
EL = sum(n*P[n] for n in range(len(P)))
EL
\end{pyconsole}

There can only be a queue when a job is in service. Since there is
$m=1$ server, we subtract $m$ from the amount of jobs in the system.
Before we do this, we need to ensure that $n-m$ does not become
negative. Thus, $\E{L_Q} = \sum_n \max\{n-m, 0\} p(n)$.

\begin{pyconsole}
m = 1
ELq = sum(max(n-m,0)*P[n] for n in range(len(P)))
ELq
\end{pyconsole}


\begin{pyconsole}
labda = 10./60
Wq = ELq/labda # in minutes
Wq
Wq/60 # in hours

W = EL/labda # in minutes
W
W/60 # in hours
\end{pyconsole}

Let's use the standard definition of the variance, i.e., $\V X = \sum_{i} (x_i-\E X)^2 \P{X=x_i}$, for once.

\begin{pyconsole}
from math import sqrt
var_L = sum((n-EL)**2*P[n] for n in range(len(P)))
var_L
sqrt(var_L)
\end{pyconsole}


\begin{pyconsole}
var_Lq = sum((max(n-m,0)-ELq)**2*P[n] for n in range(len(P)))
var_Lq
sqrt(var_Lq)
\end{pyconsole}


\begin{pyconsole}
mu = 1./(W-Wq)
1./mu # in minutes

rho = labda/mu
rho
\end{pyconsole}

\begin{pyconsole}
rho = EL-ELq
rho
\end{pyconsole}
This checks with the previous line.

The utilization must also by equal to the fraction of time the server is busy. 
\begin{pyconsole}
u = 1 - P[0]
u
\end{pyconsole}

Yet another way: Suppose we have $m$ servers. If the system is empty,
all $m$ servers are idle. If the system contains one customer, $m-1$
servers are idle. Therefore, in general, the average fraction of time
the server is idle is
\begin{equation*}
1- u = \sum_{n=0}^\infty \max\{n-m, 0\} p_n,
\end{equation*}
as in the case there are more than $m$ customers in the system, the
number of idle servers is $0$.


\begin{pyconsole}
idle = sum( max(m-n,0)*P[n] for n in range(len(P)))
idle
\end{pyconsole}

\end{solution}
 
\end{extra}

\begin{extra}
 (Hall 5.5) An $M/M/1$ queue has an arrival rate of 100 per hour and a service rate of 140 per hour.
 What is $p(n)$?
 What are $\E{L_Q}$ and $\E L$?
\begin{solution}
First, $p(n) = (1-\rho)\rho^n$. Now,

\begin{pyconsole}
labda = 100. # per hour
mu = 140. # per hour
ES = 1./mu
rho = labda/mu
rho 
1-rho

L = rho/(1.-rho)
L
Lq = rho**2/(1.-rho)
Lq

W = 1./(1.-rho) * ES
W
Wq = rho/(1.-rho) * ES
Wq
\end{pyconsole}

\end{solution}
\end{extra}

\begin{extra}[Hall 5.6]
 An $M/M/1$ queue has been found to have an average waiting time in queue of 1 minute. The arrival rate is known to be 5 customers per minute.
 What are the service rate and utilization? Calculate $\E{L_Q}$, $\E L$ and $\E W$. Finally, 
 the queue operator would like to provide chairs for waiting customers. He would like to have a sufficient number so that all customers can sit down at least 90 percent of the time. How many chairs should he provide?

\begin{hint}
$\E{L_Q}$ follows right away from an application of Little's law. For the other quantities we need to find $\E S$. One can use that 
\begin{equation*}
\E{W_Q}= \E L \E S = (\E{L_Q} + \E{L_S}) \E S = (\E{L_Q} + \lambda \E{S})\E{S}.
\end{equation*}


Now $\lambda$ and $\E{W_Q}=1$ are given, and $\E{L_Q}$ has just been computed. Hence, $\E{S}$ (which is the unknown here) can computed with the quadratic formula.

Another way is to realize that, for the $M/M/1$-queue, $\E{W_Q} = \frac{1}{\lambda}\frac{\rho^2}{1-\rho}$. Then solve for $\rho$, and since $\lambda$ is known, $\E S$ follows. 
\end{hint}
\begin{solution}


 $\E{W_Q} = \frac{1}{\lambda}\frac{\rho^2}{1-\rho}$. Since
 $\E{W_Q}$ and $\lambda$ is given we can use this formula to
 solve for $\rho$ with the quadratic formula (and using that
 $\rho > 0$):

\begin{pyconsole}
labda = 5. # per minute
Wq = 1.
a = 1.
b = labda*Wq
c = -labda*Wq
rho = (-b + sqrt(b*b-4*a*c))/(2*a)
rho 

ES = rho/labda
ES
\end{pyconsole} 


\begin{pyconsole}
Lq = labda*Wq
Lq

W = Wq + ES
W

L = labda*W
L
\end{pyconsole} 


The next problem is to find $n$ such that
 $\sum_{j=0}^n p_j > 0.9$.

\begin{pyconsole} 
total = 0. 
j = 0
while total <= 0.9:
 total += (1-rho)*rho**j
 j += 1

total
j
n = j- 1 # the number of chairs 
\end{pyconsole} 

Observe that $j$ is one too high once the condition is satisfied, thus subtract one.

As a check, I use that $(1-\rho) \sum_{j=0}^n \rho^j = 1-\rho^{n+1}$.

\begin{pyconsole}
1-rho**(n) # this must be too small.
1-rho**(n+1) # this must be OK.
\end{pyconsole} 

And indeed, we found the right $n$.

\end{solution}
\end{extra}

\begin{extra}
 (Hall 5.7) A single-server queueing system is known to have Poisson
 arrivals and exponential service times. However, the arrival rate
 and service time are state dependent. As the queue becomes longer,
 servers work faster, and the arrival rate declines, yielding the
 following functions (all in units of number per hour):
 $\lambda(0) = 5$, $\lambda(1)=3$, $\lambda(2)=2$,
 $\lambda(n)=0, n\geq 3$, $\mu(0) = 0$, $\mu(1)=2$, $\mu(2)=3$, $\mu(n)=4, n\geq 3$. 
Calculate the state probabilities, i.e., $p(n)$ for $n=0,\ldots$
\begin{hint}
Use the level-crossing equations of the $M(n)/M(n)/1$ queue.
\end{hint}
\begin{solution}
 Follows right away from the hint.
\end{solution}
\end{extra}

\begin{extra}
 (Hall 5.14) An airline phone reservation line has one server and a buffer for two customers.
 The arrival rate is 6 customers per hour, and a service rate of just 5 customers per hour.
 Arrivals are Poisson and service times are exponential.
 Estimate $\E{L_Q}$ and the average number of customers served per hour.
 Then, estimate $\E{L_Q}$ for a buffer of size~5.
 What is the impact of the increased buffer size on the number of customers served per hour?
\begin{hint}
This is a queueing system with loss, in particular the $M/M/1/1+2$ queue.
\end{hint}
\begin{solution}
First compute $\E{L_Q}$ for the case with a buffer for $2$ customers.

\begin{pyconsole}
labda = 6.
mu = 5.
rho = labda/mu
c = 1
b = 2
\end{pyconsole} 

Set $p(n) = \rho^n$ initially, and normalize later. Use the
expressions for the $M(n)/M(n)/1$ queue. Observe that $\rho>1$. Since
the size of the system is $c+b+1$ is finite, all formulas work for
this case too.


There are 4 states in total: $0,1,2,3$. (The reason to import \pyv{numpy} here and convert the lists to arrays is to fix the output precision to 3, otherwise we get long floats in the output.)

\begin{pyconsole}
import numpy as np
np.set_printoptions(precision=3)

P = np.array([rho**n for n in range(c+b+1)])
P

G = sum(P)
G

P /= G # normalize
P
\end{pyconsole} 

\begin{pyconsole}
L = sum(n*P[n] for n in range(len(P)))
L

Lq = sum((n-c)*P[n] for n in range(c,len(P)))
Lq
\end{pyconsole} 


The number of jobs served per hour must be equal to the number of jobs
accepted, i.e., not lost. The fraction of customers lost is equal to
the fraction of customers that sees a full system.

\begin{pyconsole}
lost = labda*P[-1] # the last element of P
lost

accepted = labda*(1.-P[-1]) # rate at which jobs are accepted
accepted
\end{pyconsole} 

Now increase the buffer $b$ to 5.

\begin{pyconsole}
b = 5
P = np.array([rho**n for n in range(c+b+1)])
P
G = sum(P)
G

P /= G # normalize
P

L = sum(n*P[n] for n in range(len(P)))
L

accepted = labda*(1.-P[-1])
accepted
\end{pyconsole} 
\end{solution}
\end{extra}

\begin{extra}[Hall 5.3] After observing a queue with two servers for several days, the following steady-state probabilities have been determined: $p(0)=0.4$, $p(1) = 0.3$, $p(2)=0.2$, $p(3)=0.05$ and $p(4)=0.05$.
 The arrival rate is 10 customers per hour.
 \begin{enumerate}
 \item Determine $\E L$ and $\E{L_Q}$. 
 \item Using Little's formula, determine $\E W$ and $\E{W_Q}$. 
 \item Determine $\V L$ and $\V{L_Q}$.
 \item Determine the service time and the utilization.
 \end{enumerate}
\begin{solution}
 Determine $\E L$ and $\E{L_Q}$. 

\begin{pyconsole}
P = [0.4, 0.3, 0.2, 0.05, 0.05]

c = 2
Lq = sum((n-c)*P[n] for n in range(c,len(P)))
Lq

L= sum(n*P[n] for n in range(len(P)))
L
\end{pyconsole}

 Using Little's formula, determine $\E W$ and $\E{W_Q}$. 
\begin{pyconsole}
labda = 10./60
Wq = Lq/labda # in minutes
Wq
Wq/60 # in hours

W = L/labda
W
\end{pyconsole} 

 Determine $\V L$ and $\V{L_Q}$.
\begin{pyconsole}
from math import sqrt
var_L = sum((n-L)**2*P[n] for n in range(len(P)))
var_L
sqrt(var_L)
\end{pyconsole}

\begin{pyconsole}
var_Lq = sum((max(n-c,0)-Lq)**2*P[n] for n in range(len(P)))
var_Lq
\end{pyconsole}

Determine the service time and the utilization.
\begin{pyconsole}
mu = 1./(W-Wq)
1./mu # in minutes

rho = labda/mu
rho
\end{pyconsole}

\begin{pyconsole}
rho = L-Lq
rho
\end{pyconsole}
This checks the previous line.

The utilization must also by equal to the fraction of time the server is busy. 
\begin{pyconsole}
u = 1 - P[0]
u
\end{pyconsole}
\end{solution}
\end{extra} 

\begin{extra}[Hall 5.8] The queueing system at a fast-food stand behaves in a peculiar fashion.
 When there is no one in the queue, people are reluctant to use the stand, fearing that the food is unsavory.
 People are also reluctant to use the stand when the queue is long.
 This yields the following arrival rates (in numbers per hour): $\lambda(0) = 10$, $\lambda(1)=15$, $\lambda(2)=15$, $\lambda(3)=10$, $\lambda(4)=5$, $\lambda(n)=0, n\geq 5$.
 The stand has two servers, each of which can operate at 5 per hour.
 Service times are exponential, and the arrival process is Poisson.
 Calculate the steady state probabilities.
 Next, what is the average arrival rate?
 Finally, determine $\E L$, $\E{L_Q}$, $\E W$ and $\E{W_Q}$.
\begin{solution}
First the service rates.
\begin{pyconsole}
import numpy as np
from math import factorial
labda = [10., 15., 15., 10., 5.]
c = 2
mn = 2*np.ones(len(labda)+1, dtype=int) # number of active servers
mn[0] = 0 # no service if system is empty
mn[1] = 1 # one busy server if just one job present
mu = 5*mn # service rate is 5 times no of active servers
mu
\end{pyconsole}

Since there can be arrivals in states $0,\ldots, 4$, the system can contain $0$ to $5$ customers, i.e., $p(0),\ldots, p(5)$.

Use the level-crossing result for the $M(n)/M(n)/1$ queue:

\begin{pyconsole}
P = [1]*(len(labda)+1)
for i in range(1,len(P)):
 P[i] = labda[i-1]/mu[i]*P[i-1]

P = np.array(P) # unnormalized probabilities
P
\end{pyconsole}

\begin{pyconsole}
G = sum(P) # normalization constant
G
P /= G # normalize
P 
\end{pyconsole} 

$\lambda = \sum_{n}\lambda(n) p(n)$.

\begin{pyconsole}
labdaBar = sum(labda[n]*P[n] for n in range(len(labda)))
labdaBar
\end{pyconsole}


The average number in the system is: 

\begin{pyconsole}
Ls = sum(n*P[n] for n in range(len(P)))
Ls
\end{pyconsole}


The average number in queue: 
\begin{pyconsole}
c = 2
Lq = sum((n-c)*P[n] for n in range(c,len(P)))
Lq
\end{pyconsole} 

And now the waiting times:

\begin{pyconsole}
Ws = Ls/labdaBar
Ws # time in the system

Wq = Lq/labdaBar
Wq # time in queue
\end{pyconsole} 

\end{solution}
\end{extra}

\begin{exercise}[Hall 5.10]\clabel{ex:l-217} 
A repair/maintenance facility would like to determine how many employees should be working in its tool crib.
 The service time is exponential, with mean 4 minutes, and customers arrive by a Poisson process with rate 28 per hour.
 The customers are actually maintenance workers at the facility, and are compensated at the same rate as the tool crib employees.
 What is $\E W$ for $c=1, 2, 3$, or $4$ servers?
 How many employees should work in the tool crib?
\begin{hint}
 Realize that we have to control the number of servers.
 Hence, we are dealing with a multi-server queue, i.e., the $M/M/c$ queue.
 Use~\cref{ex:7}.

The remark that maintenance workers are compensated at the same rate
as the tool crib workers confused me a bit at first. Some thought
revealed that the consequence of this remark is that is it just as
expensive to let the tool crib workers wait (to help maintenance
workers) as to let the maintenance workers wait for tools. (Recall, in
queueing systems always somebody has to wait, either the customer in queue or
the server being idle. If it is very expensive to let customers wait, the number
of servers must be high, whereas if servers are relatively expensive, customers have to do the waiting.)
\end{hint}
\begin{solution}

 Would one server/person do? 
\begin{pyconsole}
labda = 28./60 # arrivals per minute
ES = 4.
labda*ES
\end{pyconsole} 

If $c=1$, the load $\rho=\lambda \E S/c >1$ is clearly undesirable for one server. We need at
least two servers.

It is not relevant to focus on the time in the system, as time
 in service needs to be spent anyway. Hence, we focus on the waiting
 time in queue.


I just convert the formulas of~\cref{ex:7} to Python code. This saves
me time during the computations.

\begin{pyconsole}
 
def WQ(c, labda, ES):
 from math import factorial
 rho = labda*ES/c
 G = sum([(c*rho)**n/factorial(n) for n in range(c)])
 G += (c*rho)**c/(1.-rho)/factorial(c)
 Lq = (c*rho)**c/(factorial(c)*G) * rho/(1.-rho)**2
 return Lq/labda # Wq, Little's law

\end{pyconsole} 

Considering the scenario with one server is superfluous as $\rho>1$ in
that case.

What is the waiting time for $c=2$ servers?

\begin{pyconsole}
WQ(2, 28./60, 4) # in minutes
WQ(2, 28./60, 4)/60. # in hours
\end{pyconsole}

What is the waiting time for $c=3$ servers?

\begin{pyconsole}
WQ(3, 28./60, 4) # in minutes
WQ(3, 28./60, 4)/60. # in hours
\end{pyconsole}


What is the waiting time for $c=4$ servers?

\begin{pyconsole}
WQ(4, 28./60, 4) # in minutes
WQ(4, 28./60, 4)/60. # in hours
\end{pyconsole} 

In the next part of the question we will interpret these numbers.

Since both types of workers cost the same amount of money per unit
time, it is best to divide the amount of waiting/idleness equally over
both types of workers. I am inclined to reason as follows. The
average amount of waiting time done by the maintenance workers per
hour is $\lambda \E{W_Q}$. To see this, note that maintenance workers arrive at rate $\lambda$, and each worker waits on average $\E{W_Q}$ minutes. Thus, worker time is wasted at rate $\lambda \E{W_Q}$. Interestingly, with Little's law, $\E{L_Q}=\lambda \E{W_Q}$, i.e., the rate at which workers waste capacity (i.e. waiting in queue) is $\E{L_Q}$. On the other hand, the rate of work capacity wasted by the tool crib employees being idle is $c-\lambda \E{S}$, as $\lambda \E S$ is the average number of servers busy, while $c$ crib servers are available.

As both types of
employees are equally expensive, we need to choose $c$ such that
the number of maintenance workers waiting (i.e., being idle because they are waiting in queue), is equal to the number of crib workers being idle. In other words, we search for a $c$ such that $\E{L_Q} \approx c- \lambda \E S$ (where, of course, $\E{L_Q}$ depends on $c$).


\begin{pyconsole}
labda = 28./60
ES = 4.
c = 2
ELQ = labda*WQ(c, labda, ES)
ELQ
c-labda*ES
\end{pyconsole} 
Now the maintenance employees wait more than the tool crib employees.

\begin{pyconsole}
c = 3
ELQ = labda*WQ(c, labda, ES)
ELQ
c-labda*ES
\end{pyconsole} 

\begin{pyconsole}
c = 4
ELQ = labda*WQ(c, labda, ES)
ELQ
c-labda*ES
\end{pyconsole} 

Clearly, $c=3$ should do.
\end{solution}
\end{exercise}

\begin{exercise}[Hall 5.22]\clabel{ex:95}
 At a large hotel, taxi cabs arrive at a rate of 15 per hour, and parties of riders arrive at the rate of 12 per hour.
 Whenever taxicabs are waiting, riders are served immediately upon arrival.
 Whenever riders are waiting, taxicabs are loaded immediately upon arrival.
 A maximum of three cabs can wait at a time (other cabs must go elsewhere).
 \begin{enumerate}
 \item Let $p_{ij}$ be the steady-state probability of there being $i$ parties of riders and $j$ taxicabs waiting at the hotel.
 Write the state transition equation for the system.
 \item Calculate the expected number of cabs waiting and the expected number of parties waiting.
 \item Calculate the expected waiting time for cabs and the expected waiting time for parties. (For cabs, compute the average among those that do not go elsewhere.)
 \item In words, what would be the impact of allowing four cabs to wait at a time?
 \end{enumerate}
\begin{solution}
 Let $p_{ij}$ be the fraction of time that the system contains $i$ riders and $j$ taxi cabs.
 
 I assume that all members of a party of riders can be served by a single cab (that is, the parties do not exceed the capacity of a cab and all members of a party have the same destination).
 
 For clarity, write $\mu$ for the rate at which cabs arrive, and $\lambda$ for the arrival rate of parties of riders.
 
 Then the transitions are as in the figure below.
 
 Suppose first that there are $3$ taxi cabs.
 
 When a group arrives (at rate $\lambda$), there is one taxi less, and so on, until there are no more taxis left.
 
 Finally, if yet more groups arrive, they have to wait.
 
 When a new taxi arrives, the number of groups is reduced by one, and so on, until there are $3$ taxis waiting and no groups of people.


 \begin{center}

\begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto,node distance=1.8cm,
 semithick]
 \node[state] (0) {$p(0,3)$} ;
 \node[state] (1) [right of=0] {$p(0,2)$};
 \node[state] (2) [right of=1] {$p(0,1)$};
 \node[state] (3) [right of=2] {$p(0,0)$};
 \node[state] (4) [right of=3] {$p(1,0)$};
 \node[state] (5) [right of=4] {$p(2,0)$};
 \node[state] (6) [right of=5] {$p(\cdot, 0)$};

\path 
 (0) edge [bend left] node {$\lambda$} (1)
 (1) edge [bend left] node {$\mu$} (0)
 (1) edge [bend left] node {$\lambda$} (2)
 (2) edge [bend left] node {$\mu$} (1)
 (2) edge [bend left] node {$\lambda$} (3)
 (3) edge [bend left] node {$\mu$} (2)
 (3) edge [bend left] node {$\lambda$} (4)
 (4) edge [bend left] node {$\mu$} (3)
 (4) edge [bend left] node {$\lambda$} (5)
 (5) edge [bend left] node {$\mu$} (4)
 (5) edge [bend left] node {$\lambda$} (6)
 (6) edge [bend left] node {$\mu$} (5)
;
\end{tikzpicture}
 
 \end{center}

From this figure, we see that
\begin{align*}
\lambda p_{0,3} &= \mu p_{0,2} \\
(\lambda+\mu) p_{0,2} &= \mu p_{0,1} + \lambda p_{0,3}\\
(\lambda+\mu) p_{0,1} &= \mu p_{0,0} + \lambda p_{0,2}\\
(\lambda+\mu) p_{0,0} &= \mu p_{1,0} + \lambda p_{0,1}\\
(\lambda+\mu) p_{1,0} &= \mu p_{2,0} + \lambda p_{0,0}\\
(\lambda+\mu) p_{2,0} &= \mu p_{3,0} + \lambda p_{1,0}\\
\end{align*}
and so on. Thus, it is left to compute $p_{ij}$. Observe from this
scheme, or the above figure, that the situation with the taxis
correspond to an $M/M/1$ queue, only the states have a `different
name'. Let $q$ be the number of jobs in an M/M/1 queue. Some thought
will reveal that the queueing system with cabs and parties can be
mapped to an equivalent M/M/1 queueing system. In fact, consider the
following table
\begin{center}
\begin{tabular}{ccc}
$j$ & $i$ & $q$\\
3& 0 & 0\\
2 & 0& 1\\
1 & 0& 2\\
0& 0& 3\\
0& 1& 4\\
0& 2& 5\\
\end{tabular}
\end{center}
and so on. Therefore, in general, it must be that 

\begin{equation*}
q = 3 - j +i.
\end{equation*}
From the M/M/1 queue we know right away that $p_q = \rho^q
(1-\rho)$. With the above relation we can therefore immediately find
that $p_{ij} = \rho^{3-j+i}(1-\rho)$, save that $i$ and
$j$ must satisfy the constraints imposed by the model.

Second, the expected number of cabs waiting must be 
\begin{equation*}
1p_{0,1} + 2 p_{0,2} + 3p_{0,3}
\end{equation*}
and the expected number of parties waiting must be $\sum_{j=1}^\infty j p_{j,0}$.

\begin{pyconsole}
labda = 12. # per hour
mu = 15. # per hour
rho = labda/mu

def p(i,j):
 q = 3 - j + i
 return rho**q*(1.-rho)

\end{pyconsole}
Expected number of cabs waiting:
\begin{pyconsole}
Lc = sum(j*p(0,j) for j in range(0,4)) 
# Recall this sums up to 4, not including 4
Lc
 
\end{pyconsole}


To compute the expected number of parties waiting we formally have to
sum to infinity. Rather than doing the algebra, I chose to truncate
the summation at an $i$ such that $\rho^i \ll 1$, i.e.,
negligible. Truncating at 30 seems reasonable enough:

\begin{pyconsole}
trunc = 30
rho**trunc
\end{pyconsole}

At second thought this is not yet really small. 

\begin{pyconsole}
trunc = 50
rho**trunc
\end{pyconsole}


This is better. Now go for what we want to know:

\begin{pyconsole}
Lp = sum(i*p(i,0) for i in range(trunc))
Lp
\end{pyconsole}

For the last part: This is tricky. I first, naively, computed $W_q = L_c/\mu$. This
seems to make sense, as cabs arrive at rate $\mu$, so that this
expression follows from a standard application of Little's
law. However, this is wrong, of course. When using Little's law to
relate the number of jobs in queue (i.e., in the M/M/1 queue) and the
queueing time we need to use $\lambda$, not
$\mu$. Similarly (and more formally by the mapping developed in
part a), for our cab system we also need to use $\lambda$.

\begin{pyconsole}
Wq = Lc/labda
Wq
\end{pyconsole}

Thinking in templates is often useful, but makes one sloppy\ldots

What would be the impact of allowing 4 cabs? Funny question, and with the above, trivial to answer.

\begin{pyconsole}
def p(i,j):
 q = 4 - j + i
 return rho**q*(1.-rho)
 
\end{pyconsole}

\begin{pyconsole}
Lc = sum(j*p(0,j) for j in range(0,4))
Lc

Lp = sum(i*p(i,0) for i in range(trunc))
Lp
 
\end{pyconsole}
\end{solution}
\end{exercise}


\begin{extra}[Continuation of~\cref{ex:95}]
Suppose cabs are not allowed to wait. What is the expected waiting time for a party of riders?

\begin{solution}
Now we have the standard $M/M/1$ queue. The number of parties waiting must be $\E L$ of the $M/M/1$ queue. We can use Little's law to compute the waiting time.
\end{solution}
\end{extra}



\begin{exercise}[Continuation of~\cref{ex:95}]\clabel{ex:l-218}
 Did you have to use the PASTA property to solve ~\cref{ex:95}? If so, how did you use it? If not, why not?
\begin{solution}
 Actually, you don't have to use PASTA.
 So why is that?
 For instance, $\sum_{i=1}^3 i p(0, i)$ is the number of taxis waiting, and this is a time average (since we use $p(0, i)$).
 In the proof of Little's law, it is also clear that the $\E L$ is a time average.
 Also, in the proof of Little's law, we compute the waiting time as $\E W = \lim_{n\to\infty} n^{-1}\sum_{k=1}^n W_k$, where $W_k$ is the waiting time as perceived by the $k$th job.
 Thus, here $\E W$ is the average as observed by jobs.

 This was an old exam question.
 Some students used the PK-formula, see~\cref{sec:mg1}, to compute the average waiting time.
 The derivation of this \emph{does} depend on the PASTA property.
\end{solution}
\end{exercise}


\begin{exercise}[Continuation of~\cref{ex:95}]\clabel{ex:l-219}
 Suppose cabs can contain at most 4 riders, and the size of a party (i.e., a batch) has distribution $B_k$ with $\P{B_k= i} = 1/7$ for $i=1,\ldots, 7$.
 Parties of riders have the same destination, so riders of different parties cannot be served by one taxi.
 Provide a set of recursions to simulate this system.
 (This is a real hard exercise, but doable.
 I asked it at an exam to see who would deserve the highest grade.
 I was lenient with the grading\ldots)

\begin{hint}
Realize that you have model the server process separately from the queueing process. 
\end{hint}

\begin{solution}
 We concentrate on departure epochs of the taxis.
 Thus the $k$th period is the time between the departure of taxi $k-1$ and taxi $k$.
 During the $k$th epoch $a_k$ batches can arrive.

 The system starts with $a_0$ batches in queue.

 Suppose that the first batch contains 5 riders.
 Then the first taxi takes 4 riders, and 1 rider of the batch remains.
 This 1 rider will take the next taxi, and no riders of other groups can join because the riders of different parties have different destinations.
 Once all riders of a party are served, the next party in line can move to the `server' and wait to be served.

 The recursions are as follows; realize that the order in which you carry out these recursions is important. The meaning of each line is explained below the line. 
\begin{align*}
 d_s &=\min\{Q_s, 4\}, 
 \intertext{the number of riders that can depart from the party of riders in service,} 
 Q_s' &=Q_s - d_s, 
 \intertext{the remaining of number riders of a party after being served by one taxi,} 
 Q &=Q + a_k, 
 \intertext{the number of parties in queue (not in the system) just after the arrival of the batches during the $k$th interdeparture time,} p
 d_q &= \min\{Q, \1{Q_s' = 0}\}, 
 \intertext{only move a party from the queue is `the server is free',} 
 Q &= Q- d_q, 
 \intertext{move the party from the queue to the server, if allowed,} 
 Q_s &= Q_s'\1{Q_s'>0} + B_b\1{Q_s' = 0}, 
 \intertext{if the server is not free, the number of riders is equal to $Q_s'$, otherwise send the $b$th batch to the server,} 
 b &= b+ \1{Q_s'=0}, 
 \intertext{if the server is free, move the index of the batch in service to the next batch to be served once the server becomes free again.}
\end{align*}



In the code $A_k$ corresponds to a list of batches arriving on the $k$th day, $B_i$ to the size of the $i$th batch, and $a_k$ to the number of batches arriving on the $k$th period.
I used the \pyv{pysnooper} module to debug the code. It is quite hard to get it right.

\begin{pyverbatim}
A = [[5, 3, 4], [3], [6], [1, 1], [], [2], [], [], [3], []]

a = [len(A[i]) for i in range(len(A))]

B = [item for sublist in A for item in sublist]

Qs = 0
b = 0
Q = 0

for k in range(len(a)):
 ds = min(Qs, 4)
 Qs_p = Qs - ds
 Q += a[k]
 dq = min(Q, 1 * (Qs_p == 0))
 Q -= dq
 Qs = (Qs_p > 0) * Qs_p + (Qs_p == 0) * B[b]
 b += Qs_p == 0
 print(f"ds={ds}, Qs_p={Qs_p}, dq={dq}, Q={Q}, Qs={Qs}, b={b}")

\end{pyverbatim}

\end{solution}

\end{exercise}


In the above proof of Little's law we assumed that there is a sequence of moments $\{T_k, k=0,1,\ldots\}$ at which the system is empty and such that $T_k < T_{k+1}$ and $T_k \to \infty$.
However, in many practical queueing situations the system is never empty.
Thus, to be able to apply Little's law to such more general situations we should slacken the assumption that such a sequence exists.
The aim of this set of questions is to find an educated guess for a more general assumption under which Little's law can hold.


\begin{exercise}\clabel{ex:l-220}
 Motivate in words (or with a derivation, if you prefer this) why the following is true:
 \begin{equation*}
 \sum_{k=1}^{A(t)} W_k \geq \int_0^t L(s) \d s \geq \sum_{k=1}^{D(t)} W_k.
 \end{equation*}
\begin{solution}
 Intuitively, the left-hand side is all the work that arrived up to time $t$, the middle term is all the work that has been processed, and the right term all the work that left.
 Any job that that is half way its service counts for full at the left, for half in the middle expression, and not in the right.

 More formally, for any job $k$ and time $t$, we have $W_k \1{A_k \leq t} \geq \int_0^t \1{A_k \leq s < D_k } \d s \geq W_k \1{D_k \leq t}$. (To see this, fix $k$, and check the three cases $t < A_k, A_k \leq t < D_k, D_k < t$.) Then,
 \begin{equation*}
 \sum_{k=1}^\infty W_k \1{A_k \leq t} \geq \int_0^t \sum_{k=1}^\infty \1{A_k \leq t < D_k} \d s \geq \sum_{k=1}^\infty W_k \1{D_k \leq t}. 
 \end{equation*}
 Finally, note that $ \sum_{k=1}^\infty W_k \1{A_k \leq t} = \sum_{k=1}^{A(t)} W_k$ and $ \sum_{k=1}^\infty W_k \1{D_k \leq t} = \sum_{k=1}^{D(t)} W_k$, and use the definition of $L(s)$.
\end{solution}
\end{exercise}

\begin{exercise}\clabel{ex:l-221}
Take suitable limits (and assume all these limits exist) to show that 
 \begin{equation*}
\lambda \E W \geq \E L \geq \delta \E W.
 \end{equation*}
 Make explicit all the points where you use the strong law of large numbers.
\begin{solution}
 \begin{equation*}
 \lim_{t\to\infty} \frac{A(t)}{t}\frac 1{A(t)}\sum_{k=1}^{A(t)} W_k \geq \lim_{t\to \infty} \frac 1 t \int_0^t L(s) \d s \geq \lim_{t\to\infty} \frac{D(t)}{t}\frac 1{D(t)} \sum_{k=1}^{D(t)} W_k 
 \end{equation*}
 We use the strong law of large numbers to conclude that limits converges to $n^{-1} \sum_{k=1}^n W_k \to \E W$, and we assume that $\{W_k, k\geq N\}$ forms a sequence of i.i.d.
 random variables for $N$ sufficiently large.
\end{solution}
\end{exercise}


\begin{exercise}\clabel{ex:l-222}
 Suppose that $A(t) = \lambda t$ and $D(t)= [A(t) - 10]^+$.
 Explain that for this system the above assumption on $\{T_k\}$ is violated. Show that Little's law is still true.
\begin{solution}
 When $t>10$, $L(t) = 10$.
 Hence the system is never empty.
 Since still $\delta=\lim_{t\to\infty} D(t)/t = \lambda$, and $\lim_{n\to \infty} n^{-1}\sum_{k=1}^n W_k$ exists, Little's law follows.
\end{solution}
\end{exercise}

\begin{exercise}\clabel{ex:l-223}
 Based on the above formulate an educated guess for more general conditions under which Little's law holds.
 (You don't have to prove Little's law under your condition; postpone that to after the exam.)
\begin{solution}
We seem to need that $\lambda = \delta$ and that $\lim_{n\to \infty} n^{-1}\sum_{k=1}^n W_k$ exists. 
\end{solution}
\end{exercise}




\opt{solutionfiles}{
\Closesolutionfile{hint}
\Closesolutionfile{ans}
\subsection*{Hints}
\input{hint}
\subsection*{Solutions}
\input{ans}
}

%\clearpage



%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../companion"
%%% End:
